---
- name: Install PostgreSQL 18 from PGDG Repository
  hosts: pgnode
  become: yes
  become_method: sudo

  vars:
    pg_version: 18
    postgres_db: testdb
    postgres_user: testuser
    postgres_password: "Password123"

  tasks:
    - name: Install required prerequisites
      apt:
        name:
          - wget
          - ca-certificates
          - gnupg
          - lsb-release
        state: present
        update_cache: yes

    - name: Add PGDG apt repository key
      shell: |
        wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -
      args:
        warn: false

    - name: Add PGDG repository for PostgreSQL 18
      copy:
        dest: /etc/apt/sources.list.d/pgdg.list
        content: |
          deb http://apt.postgresql.org/pub/repos/apt/ {{ ansible_distribution_release }}-pgdg main

    - name: Update apt cache again
      apt:
        update_cache: yes

    - name: Install PostgreSQL 18 packages
      apt:
        name:
          - "postgresql-{{ pg_version }}"
          - "postgresql-client-{{ pg_version }}"
          - "postgresql-contrib-{{ pg_version }}"
        state: present

    - name: Ensure PostgreSQL service is started and enabled
      service:
        name: postgresql
        state: started
        enabled: yes

    # --- Workaround for Ansible postgres module bug in 2.16+ ---
    - name: Create PostgreSQL user
      shell: |
        sudo -u postgres psql -tc "SELECT 1 FROM pg_roles WHERE rolname='{{ postgres_user }}'" | grep -q 1 \
        || sudo -u postgres psql -c "CREATE USER {{ postgres_user }} WITH PASSWORD '{{ postgres_password }}';"

    - name: Create PostgreSQL database
      shell: |
        sudo -u postgres psql -tc "SELECT 1 FROM pg_database WHERE datname='{{ postgres_db }}'" | grep -q 1 \
        || sudo -u postgres psql -c "CREATE DATABASE {{ postgres_db }} OWNER {{ postgres_user }};"

    - name: Print installed PostgreSQL version
      command: psql --version
      register: pg_ver_output

    - debug:
        msg: "PostgreSQL Installed Version: {{ pg_ver_output.stdout }}"