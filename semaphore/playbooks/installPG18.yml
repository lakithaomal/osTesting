---
- name: Install PostgreSQL 18 from PGDG Repository
  hosts: pgnode
  become: yes
  become_method: sudo

  vars:
    pg_version: 18
    postgres_db: testdb
    postgres_user: testuser
    postgres_password: "Password123"

  tasks:
    - name: Install prerequisites
      apt:
        name:
          - wget
          - ca-certificates
          - gnupg
          - lsb-release
        state: present
        update_cache: yes

    - name: Add PGDG apt repo signing key (new method)
      shell: |
        wget -qO /usr/share/keyrings/postgresql.asc https://www.postgresql.org/media/keys/ACCC4CF8.asc
      args:
        creates: /usr/share/keyrings/postgresql.asc

    - name: Add PGDG repository for PostgreSQL 18
      copy:
        dest: /etc/apt/sources.list.d/pgdg.list
        content: |
          deb [signed-by=/usr/share/keyrings/postgresql.asc] http://apt.postgresql.org/pub/repos/apt {{ ansible_distribution_release }}-pgdg main

    - name: Update apt cache with new repo
      apt:
        update_cache: yes

    - name: Install PostgreSQL 18 packages
      apt:
        name:
          - "postgresql-{{ pg_version }}"
          - "postgresql-client-{{ pg_version }}"
          - "postgresql-contrib-{{ pg_version }}"
        state: present

    - name: Ensure PostgreSQL service is started and enabled
      service:
        name: postgresql
        state: started
        enabled: yes

    # --- FIXED user/database creation (module broken upstream) ---
    - name: Create PostgreSQL user if not exists
      shell: |
        sudo -u postgres psql -tc "SELECT 1 FROM pg_roles WHERE rolname='{{ postgres_user }}'" | grep -q 1 \
        || sudo -u postgres psql -c "CREATE USER {{ postgres_user }} WITH PASSWORD '{{ postgres_password }}';"

    - name: Create PostgreSQL database if not exists
      shell: |
        sudo -u postgres psql -tc "SELECT 1 FROM pg_database WHERE datname='{{ postgres_db }}'" | grep -q 1 \
        || sudo -u postgres psql -c "CREATE DATABASE {{ postgres_db }} OWNER {{ postgres_user }};"

    - name: Display installed PostgreSQL version
      command: psql --version
      register: pg_ver

    - debug:
        var: pg_ver.stdout