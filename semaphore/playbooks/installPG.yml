---
- name: Install and configure PostgreSQL on Ubuntu
  hosts: pgnode
  become: yes
  become_method: sudo

  vars:
    postgres_db: testdb
    postgres_user: testuser
    postgres_password: "Password123"

    # Fix for Ansible + become_user bug on Ubuntu
    ansible_temp_directory: /tmp

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install PostgreSQL server
      apt:
        name: postgresql
        state: present

    - name: Ensure PostgreSQL is running and enabled
      service:
        name: postgresql
        state: started
        enabled: yes

    - name: Ensure PostgreSQL user exists
      become_user: postgres
      postgresql_user:
        name: "{{ postgres_user }}"
        password: "{{ postgres_password }}"
        encrypted: no

    - name: Ensure PostgreSQL database exists
      become_user: postgres
      postgresql_db:
        name: "{{ postgres_db }}"
        owner: "{{ postgres_user }}"