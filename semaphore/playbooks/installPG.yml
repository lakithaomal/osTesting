---
- name: Install and configure PostgreSQL on Ubuntu
  hosts: pgnode
  become: yes
  become_method: sudo

  vars:
    postgres_db: testdb
    postgres_user: testuser
    postgres_password: "Password123"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install PostgreSQL server
      apt:
        name: postgresql
        state: present

    - name: Ensure PostgreSQL is running and enabled
      service:
        name: postgresql
        state: started
        enabled: yes

    # ---- FIXED: Use shell instead of postgresql_user/postgresql_db ----

    - name: Create PostgreSQL user
      shell: |
        sudo -u postgres psql -tc "SELECT 1 FROM pg_roles WHERE rolname='{{ postgres_user }}'" | grep -q 1 \
        || sudo -u postgres psql -c "CREATE USER {{ postgres_user }} WITH PASSWORD '{{ postgres_password }}';"

    - name: Create PostgreSQL database
      shell: |
        sudo -u postgres psql -tc "SELECT 1 FROM pg_database WHERE datname='{{ postgres_db }}'" | grep -q 1 \
        || sudo -u postgres psql -c "CREATE DATABASE {{ postgres_db }} OWNER {{ postgres_user }};"